import { Text, useSend } from 'alemonjs'

import { data, redis } from '@src/api/api'
import { isNotNull, shijianc, Add_灵石 } from '@src/model'

import { selects } from '@src/response/index'
export const regular = /^(#|＃|\/)?开采灵脉$/
const 宗门灵石池上限 = [
  2000000, 5000000, 8000000, 11000000, 15000000, 20000000, 25000000, 30000000
]
export default onResponse(selects, async e => {
  const Send = useSend(e)
  let usr_qq = e.UserId
  let ifexistplay = data.existData('player', usr_qq)
  if (!ifexistplay) return false
  let player = data.getData('player', usr_qq)
  if (!isNotNull(player.宗门)) {
    return false
  }
  let ass = data.getAssociation(player.宗门.宗门名称)

  if (ass.宗门驻地 == 0) {
    Send(Text(`你的宗门还没有驻地哦，没有灵脉可以开采`))
    return false
  }

  let now = new Date()
  let nowTime = now.getTime() //获取当前日期的时间戳
  let Today = await shijianc(nowTime)
  let lastsign_time = await getLastsign_Explor(usr_qq) //获得上次宗门签到日期
  if (
    Today.Y == lastsign_time.Y &&
    Today.M == lastsign_time.M &&
    Today.D == lastsign_time.D
  ) {
    Send(Text(`今日已经开采过灵脉，不可以竭泽而渔哦，明天再来吧`))
    return false
  }
  //都通过了，可以进行开采了
  await redis.set('xiuxian@1.3.0:' + usr_qq + ':getLastsign_Explor', nowTime) //redis设置签到时间

  //给奖励
  let dongTan = await data.bless_list.find(item => item.name == ass.宗门驻地)
  if (!dongTan)
    dongTan = await data.bless_list.find(item => item.name == '昆仑山')
  let gift_lingshi = 0
  if (ass.宗门神兽 == '麒麟') {
    gift_lingshi = (1200 * (dongTan.level + 1) * player.level_id) / 2
  } else {
    gift_lingshi = (1200 * dongTan.level * player.level_id) / 2
  }
  gift_lingshi *= 2
  let xf = 1
  if (ass.power == 1) {
    xf = 10
  }
  let num = Math.trunc(gift_lingshi)
  if (ass.灵石池 + num > 宗门灵石池上限[ass.宗门等级 - 1] * xf) {
    ass.灵石池 = 宗门灵石池上限[ass.宗门等级 - 1] * xf
  } else {
    ass.灵石池 += num
  }
  await Add_灵石(usr_qq, num)
  data.setAssociation(ass.宗门名称, ass)
  Send(
    Text(
      `本次开采灵脉获得${
        gift_lingshi * 2
      }灵石，上交一半给宗门，最后获得${num}灵石`
    )
  )
})
//获取上次开采灵石的时间
async function getLastsign_Explor(usr_qq) {
  //查询redis中的人物动作
  let time: any = await redis.get(
    'xiuxian@1.3.0:' + usr_qq + ':getLastsign_Explor'
  )
  if (time != null) {
    let data = await shijianc(parseInt(time))
    return data
  }
  return false
}
